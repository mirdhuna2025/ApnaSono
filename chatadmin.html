<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mirdhuna Media Gallery</title>
  <style>
    :root {
      --bg: #121212;
      --card: #1e1e1e;
      --text: #ffffff;
      --primary: #bb86fc;
      --danger: #cf6679;
      --nav: #2c2c2c;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      padding-bottom: 80px;
    }
    /* Header */
    header {
      background: var(--nav);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    h1 { margin: 0; font-size: 1.2rem; }
    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-left: 10px;
    }
    .btn-primary { background: var(--primary); color: #000; }
    .btn-danger { background: var(--danger); color: #000; }
    .btn-secondary { background: #555; color: #fff; }

    /* Gallery Grid */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .media-card {
      background: var(--card);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      aspect-ratio: 1;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    .media-card:hover { transform: scale(1.05); }
    .media-card img,
    .media-card video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
    }
    .card-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.8);
      padding: 5px;
      font-size: 0.7rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .media-card:hover .card-info { opacity: 1; }
    .delete-btn {
      background: var(--danger);
      border: none;
      color: white;
      padding: 3px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.7rem;
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .modal-content {
      max-width: 90%;
      max-height: 80%;
      border-radius: 5px;
    }
    .modal-content img,
    .modal-content video {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 5px;
    }
    .close-modal {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      cursor: pointer;
    }
    .login-box {
      background: var(--card);
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      min-width: 300px;
    }
    .login-box input {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #444;
      background: #333;
      color: white;
    }
    .user-badge {
      background: #333;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-badge img {
      width: 25px;
      height: 25px;
      border-radius: 50%;
    }
    .empty-state {
      text-align: center;
      padding: 50px;
      color: #777;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div style="display:flex; align-items:center; gap:15px;">
      <h1>üñºÔ∏è Media Gallery</h1>
      <div id="userDisplay" class="user-badge" style="display:none;">
        <img id="userAvatar" src="" alt="">
        <span id="userName">User</span>
      </div>
    </div>
    <div>
      <button class="btn btn-secondary" onclick="window.location.href='index.html'">üîô Chat</button>
      <button id="loginBtn" class="btn btn-primary">üîê Admin</button>
      <button id="logoutBtn" class="btn btn-danger" style="display:none;">üö™ Logout</button>
    </div>
  </header>

  <!-- Gallery Grid -->
  <div id="gallery" class="gallery">
    <div class="empty-state">Loading media...</div>
  </div>

  <!-- View Media Modal -->
  <div id="viewModal" class="modal">
    <span class="close-modal" onclick="closeViewModal()">&times;</span>
    <div id="viewContent" class="modal-content"></div>
  </div>

  <!-- Admin Login Modal -->
  <div id="loginModal" class="modal">
    <div class="login-box">
      <h2>Admin Login</h2>
      <input type="password" id="adminPass" placeholder="Enter Password">
      <button class="btn btn-primary" onclick="adminLogin()">Login</button>
      <button class="btn btn-secondary" onclick="closeLoginModal()">Cancel</button>
    </div>
  </div>

  <!-- Firebase Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getStorage, ref as sRef, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // üîê Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCPbOZwAZEMiC1LSDSgnSEPmSxQ7-pR2oQ",
      authDomain: "mirdhuna-25542.firebaseapp.com",
      databaseURL: "https://mirdhuna-25542-default-rtdb.firebaseio.com",
      projectId: "mirdhuna-25542",
      storageBucket: "mirdhuna-25542.firebasestorage.app",
      messagingSenderId: "575924409876",
      appId: "1:575924409876:web:6ba1ed88ce941d9c83b901"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // üß† State
    let user = JSON.parse(localStorage.getItem("chatUser")) || null;
    let isAdmin = user?.isAdmin || false;

    // üñºÔ∏è DOM Elements
    const gallery = document.getElementById("gallery");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginModal = document.getElementById("loginModal");
    const viewModal = document.getElementById("viewModal");
    const viewContent = document.getElementById("viewContent");
    const userDisplay = document.getElementById("userDisplay");
    const userName = document.getElementById("userName");
    const userAvatar = document.getElementById("userAvatar");
    const adminPassInput = document.getElementById("adminPass");

    // ‚úÖ Update UI based on auth state
    function updateUI() {
      if (user) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "block";
        userDisplay.style.display = "flex";
        userName.innerText = user.name;
        userAvatar.src = user.photoURL || `https://api.dicebear.com/7.x/thumbs/svg?seed=${user.name}`;
        if (user.isAdmin) {
          userName.innerText += " üëë";
          userName.style.color = "#bb86fc";
        }
      } else {
        loginBtn.style.display = "block";
        logoutBtn.style.display = "none";
        userDisplay.style.display = "none";
      }
      loadMedia();
    }

    // üîÑ Load & Render Media
    function loadMedia() {
      const messagesRef = ref(db, "messages");
      onValue(messagesRef, (snapshot) => {
        gallery.innerHTML = "";
        const data = snapshot.val();

        if (!data) {
          gallery.innerHTML = `<div class="empty-state">No media shared yet.</div>`;
          return;
        }

        let mediaCount = 0;
        const items = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);

        items.forEach(([key, msg]) => {
          if (!msg.mediaUrl) return; // Skip text-only
          mediaCount++;

          const card = document.createElement("div");
          card.className = "media-card";

          let mediaElement = "";
          if (msg.mediaType?.startsWith("video")) {
            mediaElement = `<video src="${msg.mediaUrl}" onclick="viewMedia('${msg.mediaUrl}', 'video')"></video>`;
          } else {
            mediaElement = `<img src="${msg.mediaUrl}" onclick="viewMedia('${msg.mediaUrl}', 'image')" />`;
          }

          const deleteBtn = user?.isAdmin
            ? `<button class="delete-btn" onclick="deleteMedia('${key}', '${msg.storagePath || ""}')">üóëÔ∏è</button>`
            : "";

          card.innerHTML = `
            ${mediaElement}
            <div class="card-info">
              <span>${msg.user || "Unknown"}</span>
              ${deleteBtn}
            </div>
          `;
          gallery.appendChild(card);
        });

        if (mediaCount === 0) {
          gallery.innerHTML = `<div class="empty-state">No media shared yet.</div>`;
        }
      });
    }

    // üóëÔ∏è Delete Media (Global Scope)
    window.deleteMedia = async (key, storagePath) => {
      if (!user?.isAdmin) return alert("üîí Admins only");
      if (!confirm("‚ö†Ô∏è Delete this media permanently?")) return;

      try {
        // Delete from Storage if path exists
        if (storagePath) {
          try {
            const fileRef = sRef(storage, storagePath);
            await deleteObject(fileRef);
          } catch (err) {
            console.warn("Storage file not found, deleting DB reference only", err);
          }
        }
        // Delete from Database
        await remove(ref(db, `messages/${key}`));
        alert("‚úÖ Media deleted");
      } catch (err) {
        alert("‚ùå Delete failed: " + err.message);
        console.error(err);
      }
    };

    // üëÅÔ∏è View Media Modal (Global Scope)
    window.viewMedia = (url, type) => {
      viewContent.innerHTML = "";
      if (type === "video") {
        viewContent.innerHTML = `<video src="${url}" controls autoplay></video>`;
      } else {
        viewContent.innerHTML = `<img src="${url}" />`;
      }
      viewModal.style.display = "flex";
    };

    window.closeViewModal = () => {
      viewModal.style.display = "none";
      viewContent.innerHTML = "";
    };

    // üîê Admin Login
    loginBtn.onclick = () => (loginModal.style.display = "flex");
    window.closeLoginModal = () => (loginModal.style.display = "none");

    window.adminLogin = () => {
      if (adminPassInput.value === "sanu0000") {
        user = { name: "Admin", photoURL: "", isAdmin: true };
        localStorage.setItem("chatUser", JSON.stringify(user));
        isAdmin = true;
        loginModal.style.display = "none";
        adminPassInput.value = "";
        updateUI();
        alert("‚úÖ Admin Access Granted");
      } else {
        alert("‚ùå Wrong Password");
      }
    };

    // üö™ Logout
    logoutBtn.onclick = () => {
      if (!confirm("Logout?")) return;
      localStorage.removeItem("chatUser");
      user = null;
      isAdmin = false;
      updateUI();
      location.reload();
    };

    // Close modals on outside click
    window.onclick = (event) => {
      if (event.target === viewModal) closeViewModal();
      if (event.target === loginModal) closeLoginModal();
    };

    // üöÄ Initialize
    updateUI();
  </script>
</body>
</html>
