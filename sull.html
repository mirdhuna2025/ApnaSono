<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Listings (React + Firebase 10)</title>

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
/* Header */
header {
  backdrop-filter: blur(12px);
  background: #d4edda;   
  position: sticky;
  top: 0;
  z-index: 1000;
  padding: 1px 0;
}
.header-container {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  width: 90%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 18px;
}
.sono-olx {
  background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
  background-size: 400% 400%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: rainbow 4s ease infinite;
  font-size: 2.3rem;
  letter-spacing: -1px;
  margin: 0;
  font-family: 'Playfair Display', serif;
}
@keyframes rainbow {
  0% { background-position: 0% 50% }
  50% { background-position: 100% 50% }
  100% { background-position: 0% 50% }
}

/* Root & Cards */
:root{
  --primary:#25D366;
  --danger:#ef4444;
  --bg:#f4f6f8;
  --card:#ffffff;
  --radius:14px;
  --shadow:0 10px 25px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg)}
#listingsContainer{
  display:grid;
  gap:12px;
  padding:12px;
  grid-template-columns: repeat(2, 1fr); /* mobile */
}

@media(min-width:768px){
  #listingsContainer{
    grid-template-columns: repeat(3, 1fr);
  }
}

@media(min-width:1024px){
  #listingsContainer{
    grid-template-columns: repeat(4, 1fr);
  }
}
/* Card */
.item-card{
  background:var(--card);
  border-radius:var(--radius);
  margin-bottom:16px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.item-info{padding:12px}
.item-title{font-weight:600}
.item-price{color:var(--danger);font-weight:700}

/* Slider */
.slider{position:relative; cursor:pointer;}
.slider img{
  width:100%;
  height:220px;
  object-fit:cover;
}
.dots{
  position:absolute;
  bottom:8px;
  width:100%;
  display:flex;
  justify-content:center;
  gap:6px;
}
.dot{
  width:8px;height:8px;border-radius:50%;
  background:#ddd;
}
.dot.active{background:#25D366}

/* Buttons */
.btn{
  padding:10px 14px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-weight:600;
  display:inline-block;
  margin-top:8px;
}
.btn-success{background:#25D366;color:#fff}

/* FAB */
.fab {
  position: fixed;
  bottom: 22px;
  right: 22px;
  width: 75px;
  height: 75px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #ff6a00, #ff3d00);
  color: white;
  border: none;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  cursor: pointer;
  z-index: 9999;
}
.fab::after {
  content: '';
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: inherit;
  background: inherit;
  filter: blur(12px);
  opacity: 0.5;
  z-index: -1;
}

/* Modal */
#modalBackdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:flex;
  align-items:center;
  justify-content:center;
}
#modalContent{
  background:#fff;
  width:92%;
  max-width:420px;
  padding:18px;
  border-radius:14px;
  position:relative;
}
#modalContent input{
  width:100%;
  padding:12px;
  margin-bottom:10px;
}
.close-btn{
  position:absolute;
  top:10px;
  right:12px;
  background:none;
  border:none;
  font-size:18px;
  cursor:pointer;
  font-weight:bold;
  color:#555;
}
.close-btn:hover{
  color:#ef4444;
}

/* Image Preview */
#previewBackdrop{
  position: fixed;
  inset:0;
  background: rgba(0,0,0,0.85);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10000;
}
#previewBackdrop img{
  max-width:95%;
  max-height:95%;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,0.5);
  object-fit:contain;
}
</style>
</head>

<body>

<header>
  <div class="header-container">
    <h1 class="sono-olx">SONO OLX</h1>
  </div>
</header>

<div id="root"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getStorage, ref, listAll, getDownloadURL, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

window.firebase = (() => {
  const firebaseConfig = {
    apiKey: "AIzaSyCPbOZwAZEMiC1LSDSgnSEPmSxQ7-pR2oQ",
    authDomain: "mirdhuna-25542.firebaseapp.com",
    projectId: "mirdhuna-25542",
    storageBucket: "mirdhuna-25542.firebasestorage.app",
    appId: "1:575924409876:web:6ba1ed88ce941d9c83b901"
  };
  const app = initializeApp(firebaseConfig);
  return { storage: getStorage(app), ref, listAll, getDownloadURL, uploadBytes };
})();
</script>

<script type="text/babel">
const {useState,useEffect} = React;

/* Slider with preview */
function Slider({images=[], onPreview}) {
  const [i,setI] = useState(0);
  useEffect(()=>{
    if(images.length<2) return;
    const t = setInterval(()=>setI(x=>(x+1)%images.length),3000);
    return ()=>clearInterval(t);
  },[images]);
  if(!images.length) return null;

  return(
    <div className="slider">
      <img src={images[i]} onClick={()=>onPreview(i)} />
      <div className="dots">
        {images.map((_,d)=>(
          <span key={d} className={"dot "+(d===i?"active":"")}></span>
        ))}
      </div>
    </div>
  );
}

function App(){
  const [listings,setListings]=useState([]);
  const [modal,setModal]=useState(false);
  const [form,setForm]=useState({});
  const [files,setFiles]=useState([]);
  const [preview,setPreview]=useState({open:false, images:[], index:0});

  /* Load listings safely */
  useEffect(()=>{
    const load=async()=>{
      try{
        const {storage,ref,listAll,getDownloadURL}=window.firebase;
        const folder=ref(storage,"listings");
        const res=await listAll(folder);

        const items=await Promise.all(
          res.prefixes.map(async p=>{
            try{
              const meta=await getDownloadURL(ref(storage,p.fullPath+"/data.json"));
              return await (await fetch(meta)).json();
            }catch{return null;}
          })
        );

        const clean = items.filter(Boolean).sort((a,b)=>b.createdAt-a.createdAt);
        setListings(clean);
      }catch(err){ console.log("No listings found"); }
    };
    load();
  },[]);

  async function sendToAdmin(e){
    e.preventDefault();
    const { storage, ref, uploadBytes, getDownloadURL } = window.firebase;
    const id = Date.now().toString();
    const basePath = "pendingListings/" + id;
    const imageUrls = [];
    for(const f of files){
      const imgRef = ref(storage, `${basePath}/images/${f.name}`);
      await uploadBytes(imgRef, f);
      imageUrls.push(await getDownloadURL(imgRef));
    }
    const data = { ...form, images: imageUrls, status:"pending", createdAt:Date.now() };
    const blob = new Blob([JSON.stringify(data)], { type:"application/json" });
    await uploadBytes(ref(storage, `${basePath}/data.json`), blob);
    alert("âœ… Listing sent for admin approval");
    setModal(false); setForm({}); setFiles([]);
  }

  return(
    <>
      <button className="fab" onClick={()=>setModal(true)}>+ Sell</button>

      <div id="listingsContainer">
        {listings.map((i,idx)=>(
          <div className="item-card" key={idx}>
            <Slider images={i.images} onPreview={index=>setPreview({open:true, images:i.images, index})} />
            <div className="item-info">
              <div className="item-title">{i.title}</div>
              <div className="item-price">â‚¹{i.price}</div>
              <a className="btn btn-success" target="_blank" rel="noopener noreferrer" href={`https://wa.me/91${i.mobile}`}>
                ðŸ’¬ WhatsApp
              </a>
            </div>
          </div>
        ))}
      </div>

      {/* Add Listing Modal */}
      {modal && (
        <div id="modalBackdrop" onClick={()=>setModal(false)}>
          <div id="modalContent" onClick={e=>e.stopPropagation()}>
            <button className="close-btn" onClick={()=>setModal(false)}>âœ–</button>
            <h3>Add Listing</h3>
            <form onSubmit={sendToAdmin}>
              <input placeholder="Title" required onChange={e=>setForm({...form,title:e.target.value})}/>
              <input type="number" placeholder="Price" required onChange={e=>setForm({...form,price:e.target.value})}/>
              <input placeholder="Location" required onChange={e=>setForm({...form,location:e.target.value})}/>
              <input placeholder="Mobile" required onChange={e=>setForm({...form,mobile:e.target.value})}/>
              <input type="file" multiple accept="image/*" required onChange={e=>setFiles([...e.target.files])}/>
              <button className="btn btn-success">Send to Admin</button>
            </form>
          </div>
        </div>
      )}

      {/* Image Preview Modal */}
      {preview.open && (
        <div id="previewBackdrop" onClick={()=>setPreview({open:false, images:[], index:0})}>
          <img src={preview.images[preview.index]} />
        </div>
      )}
    </>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>

</body>
</html>
