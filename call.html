<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Video Call</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2a6c, #2c3e50, #4a6491);
      color: #fff;
      line-height: 1.6;
      padding: 15px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .container {
      max-width: 1000px;
      width: 100%;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      padding: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    h1 {
      font-size: 2.2rem;
      margin-bottom: 10px;
      background: linear-gradient(to right, #4facfe, #00f2fe);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: 1px;
    }
    
    .subtitle {
      color: #e0e0ff;
      font-size: 1.1rem;
      margin-top: 8px;
    }
    
    .user-info {
      background: rgba(0, 20, 40, 0.7);
      border-radius: 15px;
      padding: 12px;
      margin: 15px 0;
      text-align: center;
      border: 1px solid rgba(100, 180, 255, 0.3);
      font-size: 1.1rem;
    }
    
    .videos-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin: 20px 0;
    }
    
    @media (min-width: 768px) {
      .videos-container {
        flex-direction: row;
        justify-content: space-around;
      }
    }
    
    .video-wrapper {
      position: relative;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      background: #000;
      width: 100%;
      max-width: 400px;
      min-height: 250px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .video-placeholder {
      color: rgba(255, 255, 255, 0.5);
      font-size: 1.2rem;
      text-align: center;
      padding: 20px;
    }
    
    .video-wrapper.local {
      border: 3px solid #4facfe;
    }
    
    .video-wrapper.remote {
      border: 3px solid #00f2fe;
    }
    
    .video-label {
      position: absolute;
      bottom: 10px;
      left: 0;
      right: 0;
      text-align: center;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 5px;
      font-weight: bold;
      border-radius: 0 0 10px 10px;
      z-index: 10;
    }
    
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      background: #000;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 25px 0;
      padding: 15px;
      background: rgba(0, 20, 45, 0.7);
      border-radius: 20px;
      border: 1px solid rgba(100, 180, 255, 0.2);
    }
    
    @media (min-width: 768px) {
      .controls {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }
    }
    
    .main-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }
    
    @media (min-width: 768px) {
      .main-controls {
        flex-direction: row;
        justify-content: center;
      }
    }
    
    button {
      background: linear-gradient(to right, #4facfe, #00f2fe);
      color: white;
      border: none;
      padding: 14px 20px;
      font-size: 1.1rem;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 180px;
      flex: 1;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.35);
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    button.start {
      background: linear-gradient(to right, #00c853, #00e676);
      min-width: 200px;
      margin: 0 auto;
    }
    
    button.create {
      background: linear-gradient(to right, #ffab00, #ffd149);
    }
    
    button.answer {
      background: linear-gradient(to right, #00c853, #00e676);
      display: none;
    }
    
    button.hangup {
      background: linear-gradient(to right, #ff1744, #ff5252);
      display: none;
    }
    
    .call-id-section {
      text-align: center;
      margin: 15px 0;
      padding: 15px;
      background: rgba(0, 25, 60, 0.8);
      border-radius: 15px;
      border: 1px dashed #4facfe;
    }
    
    .call-id-section h3 {
      margin-bottom: 10px;
      color: #4facfe;
    }
    
    .call-id-container {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-direction: column;
    }
    
    @media (min-width: 768px) {
      .call-id-container {
        flex-direction: row;
        justify-content: center;
      }
    }
    
    #callInput {
      padding: 12px 15px;
      border-radius: 50px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 20, 45, 0.8);
      color: white;
      font-size: 1.1rem;
      width: 100%;
      text-align: center;
      transition: all 0.3s;
      max-width: 300px;
    }
    
    #callInput:focus {
      outline: none;
      border-color: #4facfe;
      box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.3);
    }
    
    #callInput.valid {
      border-color: #00e676;
      box-shadow: 0 0 0 3px rgba(0, 230, 118, 0.3);
    }
    
    #callInput.invalid {
      border-color: #ff5252;
      box-shadow: 0 0 0 3px rgba(255, 82, 82, 0.3);
    }
    
    .status-bar {
      background: rgba(0, 25, 50, 0.85);
      border-radius: 15px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
      min-height: 30px;
      border: 1px solid rgba(100, 180, 255, 0.2);
      font-weight: 500;
      font-size: 1.1rem;
      transition: all 0.3s ease;
    }
    
    .status-bar.calling {
      background: rgba(255, 165, 0, 0.15);
      color: #ffd149;
      animation: pulse 2s infinite;
    }
    
    .status-bar.connected {
      background: rgba(0, 200, 83, 0.15);
      color: #00e676;
      animation: none;
    }
    
    .status-bar.incoming {
      background: rgba(255, 235, 59, 0.2);
      color: #ffeb3b;
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 15px rgba(255, 235, 59, 0.5);
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
    }
    
    .instructions {
      background: rgba(0, 30, 60, 0.7);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      line-height: 1.7;
      border: 1px solid rgba(100, 180, 255, 0.2);
    }
    
    .instructions h3 {
      color: #4facfe;
      margin-bottom: 12px;
      text-align: center;
      font-size: 1.4rem;
    }
    
    .instructions ol {
      padding-left: 20px;
      margin-top: 10px;
      font-size: 1.05rem;
    }
    
    .instructions li {
      margin-bottom: 8px;
    }
    
    .call-flow {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin: 20px 0;
      text-align: center;
    }
    
    .flow-step {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
      padding: 8px 15px;
      border-radius: 10px;
      background: rgba(0, 30, 60, 0.6);
      width: 100%;
      max-width: 600px;
    }
    
    .flow-step.active {
      background: rgba(79, 172, 254, 0.25);
      border-left: 4px solid #4facfe;
      font-weight: bold;
    }
    
    .flow-icon {
      width: 28px;
      height: 28px;
      background: rgba(79, 172, 254, 0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .hidden {
      display: none;
    }
    
    footer {
      text-align: center;
      margin-top: 25px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.9rem;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .controls {
        padding: 10px;
      }
      
      button {
        padding: 12px;
        font-size: 1rem;
        min-width: 150px;
      }
      
      .call-id-container {
        flex-direction: column;
        align-items: center;
      }
      
      #callInput {
        max-width: 100%;
      }
      
      .video-wrapper {
        max-width: 100%;
        min-height: 200px;
      }
    }
    
    .connection-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: #00e676;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.85rem;
      display: none;
    }
    
    .connection-badge.connected {
      display: block;
    }
    
    .connection-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      background: #ff5252;
      border-radius: 50%;
      margin-right: 5px;
      vertical-align: middle;
    }
    
    .connection-indicator.connected {
      background: #00e676;
      box-shadow: 0 0 8px #00e676;
    }
    
    .connection-indicator.incoming {
      background: #ffeb3b;
      box-shadow: 0 0 8px #ffeb3b;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>âœ¨ Simple Video Call</h1>
      <div class="subtitle">Connect with anyone in seconds</div>
    </header>
    
    <div class="user-info">
      <div>Hi, <strong id="usernameDisplay">Guest</strong>! Ready to connect?</div>
    </div>
    
    <div class="videos-container">
      <div class="video-wrapper local">
        <div class="video-placeholder" id="localPlaceholder">
          <div>ðŸ“¹ Your camera will appear here</div>
          <div class="connection-indicator" id="localStatus"></div>
        </div>
        <video id="localVideo" autoplay muted playsinline></video>
        <div class="video-label">You</div>
        <div class="connection-badge" id="localConnection">Connected</div>
      </div>
      <div class="video-wrapper remote">
        <div class="video-placeholder" id="remotePlaceholder">
          <div>ðŸ‘¥ Remote user will appear here</div>
          <div class="connection-indicator" id="remoteStatus"></div>
        </div>
        <video id="remoteVideo" autoplay playsinline></video>
        <div class="video-label" id="remoteLabel">Contact</div>
        <div class="connection-badge" id="remoteConnection">Connected</div>
      </div>
    </div>
    
    <div class="status-bar" id="statusBar">
      <div class="connection-indicator" id="statusIndicator"></div>
      Start your camera to begin
    </div>
    
    <div class="controls">
      <div class="main-controls">
        <button id="startBtn" class="start">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg>
          Start Camera
        </button>
        <button id="createBtn" class="create" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          Create Call Link
        </button>
        <button id="answerBtn" class="answer">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
          Answer Call
        </button>
        <button id="hangupBtn" class="hangup">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
          Hang Up
        </button>
      </div>
      
      <div class="call-id-section">
        <h3>Call Link</h3>
        <div class="call-id-container">
          <input type="text" id="callInput" placeholder="Paste call link here" maxlength="30">
          <button id="copyBtn" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            Copy Link
          </button>
        </div>
        <div id="callLinkDisplay" class="hidden" style="margin-top: 10px; font-family: monospace; word-break: break-all; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px;"></div>
      </div>
    </div>
    
    <div class="call-flow">
      <div class="flow-step active" id="step1">
        <div class="flow-icon">1</div>
        <div>Start your camera</div>
      </div>
      <div class="flow-step" id="step2">
        <div class="flow-icon">2</div>
        <div>Create a call link or paste one you received</div>
      </div>
      <div class="flow-step" id="step3">
        <div class="flow-icon">3</div>
        <div>Connect with your contact</div>
      </div>
    </div>
    
    <div class="instructions">
      <h3>How It Works</h3>
      <ol>
        <li>Click "Start Camera" to enable your webcam and microphone</li>
        <li>To start a call: Click "Create Call Link" and share it with your contact</li>
        <li>To join a call: Paste the link you received and click "Answer Call"</li>
        <li>When connected, you'll see each other's video feeds</li>
        <li>Click "Hang Up" anytime to end the call</li>
      </ol>
    </div>
    
    <footer>
      <p>Simple Video Calling â€¢ Powered by WebRTC & Firebase</p>
    </footer>
  </div>

  <script>
    // Firebase configuration - REPLACE WITH YOUR OWN CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyD7h2Tk85P8XOsXyQzRQzR6P7v7v7v7v7v",
      authDomain: "your-project.firebaseapp.com",
      projectId: "your-project-id"
    };

    // Initialize Firebase
    if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "AIzaSyD7h2Tk85P8XOsXyQzRQzR6P7v7v7v7v7v") {
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
    } else {
      alert("Please configure your Firebase project in the code before using this application.");
      throw new Error("Firebase not configured");
    }

    /* WebRTC Setup */
    const servers = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "stun:stun1.l.google.com:19302" }
      ]
    };

    let pc = null;
    let localStream = null;
    let remoteStream = null;
    let currentCallId = null;
    let isCaller = false;
    let callDocRef = null;
    let offerCandidatesRef = null;
    let answerCandidatesRef = null;

    // DOM Elements
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const remoteLabel = document.getElementById("remoteLabel");
    const startBtn = document.getElementById("startBtn");
    const createBtn = document.getElementById("createBtn");
    const answerBtn = document.getElementById("answerBtn");
    const hangupBtn = document.getElementById("hangupBtn");
    const callInput = document.getElementById("callInput");
    const copyBtn = document.getElementById("copyBtn");
    const statusBar = document.getElementById("statusBar");
    const statusIndicator = document.getElementById("statusIndicator");
    const callLinkDisplay = document.getElementById("callLinkDisplay");
    const usernameDisplay = document.getElementById("usernameDisplay");
    const localPlaceholder = document.getElementById("localPlaceholder");
    const remotePlaceholder = document.getElementById("remotePlaceholder");
    const localStatus = document.getElementById("localStatus");
    const remoteStatus = document.getElementById("remoteStatus");
    const localConnection = document.getElementById("localConnection");
    const remoteConnection = document.getElementById("remoteConnection");
    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const step3 = document.getElementById("step3");

    // Initialize username
    let username = localStorage.getItem('simpleVideoCallUsername');
    if (!username) {
      username = prompt('Enter your name for video calls:', 'Friend');
      if (username && username.trim() !== '') {
        username = username.trim();
        localStorage.setItem('simpleVideoCallUsername', username);
      } else {
        username = 'Friend';
        localStorage.setItem('simpleVideoCallUsername', username);
      }
    }
    usernameDisplay.textContent = username;
    
    // Initialize remote stream
    remoteStream = new MediaStream();
    remoteVideo.srcObject = remoteStream;

    // Initialize connection indicators
    localStatus.classList.add('connected');
    remoteStatus.classList.remove('connected');
    localConnection.classList.add('connected');
    remoteConnection.classList.remove('connected');

    // Setup event listeners
    startBtn.addEventListener('click', startCamera);
    createBtn.addEventListener('click', createCall);
    answerBtn.addEventListener('click', answerCall);
    hangupBtn.addEventListener('click', hangUp);
    copyBtn.addEventListener('click', copyCallLink);
    callInput.addEventListener('input', handleCallInput);

    // Initialize UI states
    updateStatus("Start your camera to begin", "ready");
    answerBtn.style.display = "none";
    hangupBtn.style.display = "none";
    copyBtn.disabled = true;

    // Start camera when page loads if permissions already granted
    checkCameraPermissions();

    // Functions
    async function checkCameraPermissions() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const hasCamera = devices.some(device => device.kind === 'videoinput');
        const hasMic = devices.some(device => device.kind === 'audioinput');
        
        if (hasCamera && hasMic) {
          // Auto-start camera if permissions already granted
          const storedPermission = localStorage.getItem('cameraPermissionGranted');
          if (storedPermission === 'true') {
            startBtn.click();
          }
        }
      } catch (err) {
        console.error("Error checking camera permissions:", err);
      }
    }

    async function startCamera() {
      try {
        updateStatus("Starting camera...", "connecting");
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: true
        });

        // Display local video
        localVideo.srcObject = localStream;
        localPlaceholder.style.display = "none";
        localVideo.style.display = "block";
        
        // Save permission state
        localStorage.setItem('cameraPermissionGranted', 'true');
        
        // Enable call creation
        createBtn.disabled = false;
        callInput.disabled = false;
        
        // Update UI states
        updateStatus("Camera ready! Create a call link or paste one you received", "ready");
        step1.classList.remove('active');
        step2.classList.add('active');
        
        startBtn.style.display = "none";
        answerBtn.style.display = "flex";
        
        // Setup connection indicators
        localStatus.classList.add('connected');
        localConnection.classList.add('connected');
        
      } catch (error) {
        console.error("Error accessing media devices:", error);
        updateStatus("Error: " + (error.message || "Could not access camera/microphone"), "error");
        alert("Error accessing camera/microphone. Please check permissions and try again.");
      }
    }

    function handleCallInput() {
      const callId = callInput.value.trim();
      
      // Reset validation styles
      callInput.classList.remove('valid', 'invalid');
      
      if (callId.length < 5) {
        copyBtn.disabled = true;
        answerBtn.disabled = true;
        return;
      }
      
      // Validate call ID format (simple validation)
      if (/^[a-zA-Z0-9\-_]{5,30}$/.test(callId)) {
        callInput.classList.add('valid');
        copyBtn.disabled = false;
        answerBtn.disabled = false;
        
        // Auto-show answer button if we have a valid ID and camera is started
        if (localStream) {
          answerBtn.style.display = "flex";
          createBtn.style.display = "none";
          
          // Check if this call exists in Firebase
          checkCallExists(callId);
        }
      } else {
        callInput.classList.add('invalid');
        copyBtn.disabled = true;
        answerBtn.disabled = true;
      }
    }

    async function checkCallExists(callId) {
      try {
        const docRef = db.collection("calls").doc(callId);
        const docSnap = await docRef.get();
        
        if (docSnap.exists) {
          const callData = docSnap.data();
          if (callData.offer && !callData.answer) {
            // This is an incoming call
            updateStatus(`Incoming call from ${callData.caller || 'someone'}! Click "Answer Call" to connect.`, "incoming");
            remoteLabel.textContent = callData.caller || "Contact";
            statusIndicator.classList.add('incoming');
            remoteStatus.classList.add('incoming');
            step2.classList.remove('active');
            step3.classList.add('active');
          } else if (callData.answer) {
            // Call already answered
            updateStatus("This call has already been answered. Please create a new call link.", "error");
          }
        } else {
          // New call ID - treat as creating a new call
          if (isCaller) {
            updateStatus("Share this call link with your contact to connect", "ready");
          }
        }
      } catch (error) {
        console.error("Error checking call:", error);
      }
    }

    async function createCall() {
      if (!localStream) {
        alert("Please start your camera first!");
        return;
      }
      
      isCaller = true;
      
      // Generate call ID from current timestamp and random string
      const timestamp = Date.now().toString(36);
      const randomStr = Math.random().toString(36).substr(2, 5);
      currentCallId = `call-${timestamp}-${randomStr}`;
      
      // Setup peer connection
      setupPeerConnection();
      
      // Create Firestore references
      callDocRef = db.collection("calls").doc(currentCallId);
      offerCandidatesRef = callDocRef.collection("offerCandidates");
      answerCandidatesRef = callDocRef.collection("answerCandidates");
      
      // Set up ICE candidate handling
      pc.onicecandidate = event => {
        if (event.candidate) {
          offerCandidatesRef.add(event.candidate.toJSON());
        }
      };
      
      try {
        updateStatus("Creating call link...", "calling");
        const offerDescription = await pc.createOffer();
        await pc.setLocalDescription(offerDescription);
        
        // Save offer to Firestore
        await callDocRef.set({
          offer: {
            type: offerDescription.type,
            sdp: offerDescription.sdp,
          },
          caller: username,
          callee: null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Listen for answer
        callDocRef.onSnapshot(snapshot => {
          if (!pc.currentRemoteDescription && snapshot.data()?.answer) {
            const answer = snapshot.data().answer;
            pc.setRemoteDescription(new RTCSessionDescription(answer));
          }
          
          // Update if callee has answered
          if (snapshot.data()?.callee && remoteLabel.textContent === "Contact") {
            remoteLabel.textContent = snapshot.data().callee;
          }
        });
        
        // Listen for ICE candidates from answerer
        answerCandidatesRef.onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
              const candidate = new RTCIceCandidate(change.doc.data());
              pc.addIceCandidate(candidate);
            }
          });
        });
        
        // Display the call link
        callInput.value = currentCallId;
        callLinkDisplay.textContent = `${window.location.origin}${window.location.pathname}?call=${currentCallId}`;
        callLinkDisplay.classList.remove('hidden');
        callInput.classList.add('valid');
        copyBtn.disabled = false;
        
        // Update UI
        updateStatus("Share this call link with your contact to connect", "calling");
        createBtn.disabled = true;
        answerBtn.style.display = "none";
        copyBtn.style.display = "flex";
        step2.classList.remove('active');
        step3.classList.add('active');
        
      } catch (error) {
        console.error("Error creating call:", error);
        updateStatus("Error creating call: " + error.message, "error");
        resetCall();
      }
    }

    async function answerCall() {
      const callId = callInput.value.trim();
      if (!callId) {
        alert("Please enter a call link!");
        return;
      }
      
      if (!localStream) {
        alert("Please start your camera first!");
        return;
      }
      
      currentCallId = callId;
      isCaller = false;
      
      // Setup peer connection
      setupPeerConnection();
      
      // Setup Firestore references
      callDocRef = db.collection("calls").doc(callId);
      offerCandidatesRef = callDocRef.collection("offerCandidates");
      answerCandidatesRef = callDocRef.collection("answerCandidates");
      
      // Set up ICE candidate handling
      pc.onicecandidate = event => {
        if (event.candidate) {
          answerCandidatesRef.add(event.candidate.toJSON());
        }
      };
      
      try {
        updateStatus("Joining call...", "connecting");
        const callDoc = await callDocRef.get();
        
        if (!callDoc.exists) {
          throw new Error("Call not found. Please check the link.");
        }
        
        const callData = callDoc.data();
        if (!callData.offer) {
          throw new Error("Invalid call data. Offer not found.");
        }
        
        // Set remote description (offer)
        const offerDescription = callData.offer;
        await pc.setRemoteDescription(new RTCSessionDescription(offerDescription));
        
        // Create answer
        const answerDescription = await pc.createAnswer();
        await pc.setLocalDescription(answerDescription);
        
        // Update call document with answer and callee info
        await callDocRef.update({
          answer: {
            type: answerDescription.type,
            sdp: answerDescription.sdp,
          },
          callee: username
        });
        
        // Listen for ICE candidates from caller
        offerCandidatesRef.onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
              const data = change.doc.data();
              pc.addIceCandidate(new RTCIceCandidate(data));
            }
          });
        });
        
        // Listen for call hangup
        callDocRef.onSnapshot(snapshot => {
          if (!snapshot.exists) {
            // Call document deleted - call ended
            if (pc.connectionState === "connected") {
              updateStatus("Call ended by remote user", "disconnected");
              hangUp();
            }
          }
        });
        
        // Update UI
        remoteLabel.textContent = callData.caller || "Contact";
        answerBtn.style.display = "none";
        hangupBtn.style.display = "flex";
        createBtn.style.display = "none";
        copyBtn.style.display = "none";
        step2.classList.remove('active');
        step3.classList.add('active');
        
      } catch (error) {
        console.error("Error answering call:", error);
        updateStatus("Error: " + error.message, "error");
        resetCall();
        alert(error.message);
      }
    }

    function setupPeerConnection() {
      // Clean up existing connection if any
      if (pc) {
        pc.close();
      }
      
      pc = new RTCPeerConnection(servers);
      
      // Add local tracks
      if (localStream) {
        localStream.getTracks().forEach(track => {
          pc.addTrack(track, localStream);
        });
      }
      
      // Handle incoming tracks
      pc.ontrack = event => {
        event.streams[0].getTracks().forEach(track => {
          if (!remoteStream.getTrackById(track.id)) {
            remoteStream.addTrack(track);
          }
        });
        
        // Show remote video
        remotePlaceholder.style.display = "none";
        remoteVideo.style.display = "block";
        
        // Update connection indicators
        remoteStatus.classList.add('connected');
        remoteConnection.classList.add('connected');
        
        updateStatus(`Connected with ${remoteLabel.textContent}!`, "connected");
        hangupBtn.style.display = "flex";
      };
      
      // Handle connection state changes
      pc.onconnectionstatechange = () => {
        console.log("Connection state:", pc.connectionState);
        
        if (pc.connectionState === "connected") {
          updateStatus(`Connected with ${remoteLabel.textContent}!`, "connected");
          statusIndicator.classList.add('connected');
          remoteStatus.classList.add('connected');
          remoteConnection.classList.add('connected');
          
          // Hide call creation/answer buttons
          createBtn.style.display = "none";
          answerBtn.style.display = "none";
          copyBtn.style.display = "none";
          
        } else if (pc.connectionState === "disconnected" || pc.connectionState === "failed") {
          if (pc.connectionState === "failed") {
            pc.restartIce();
          }
          if (currentCallId) {
            updateStatus("Connection lost. Reconnecting...", "connecting");
          }
        } else if (pc.connectionState === "closed") {
          if (currentCallId) {
            updateStatus("Call ended", "disconnected");
          }
        }
      };
    }

    function copyCallLink() {
      const link = callLinkDisplay.textContent;
      if (link) {
        navigator.clipboard.writeText(link).then(() => {
          copyBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            Copied!`;
          setTimeout(() => {
            copyBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
              Copy Link`;
          }, 2000);
        }).catch(err => {
          console.error("Failed to copy:", err);
          alert("Failed to copy link. Please copy manually.");
        });
      }
    }

    function hangUp() {
      // Delete call document to signal hangup
      if (callDocRef && currentCallId) {
        callDocRef.delete().catch(console.error);
      }
      
      resetCall();
    }

    function resetCall() {
      // Close peer connection
      if (pc) {
        pc.close();
        pc = null;
      }
      
      // Clear remote video
      if (remoteStream) {
        remoteStream.getTracks().forEach(track => track.stop());
        remoteStream = new MediaStream();
        remoteVideo.srcObject = remoteStream;
      }
      
      // Reset UI
      remotePlaceholder.style.display = "flex";
      remoteVideo.style.display = "none";
      callLinkDisplay.classList.add('hidden');
      callInput.value = "";
      callInput.classList.remove('valid', 'invalid');
      copyBtn.disabled = true;
      createBtn.disabled = false;
      createBtn.style.display = "flex";
      answerBtn.style.display = "none";
      hangupBtn.style.display = "none";
      copyBtn.style.display = "flex";
      
      // Reset connection indicators
      remoteStatus.classList.remove('connected', 'incoming');
      remoteConnection.classList.remove('connected');
      statusIndicator.classList.remove('connected', 'incoming');
      
      // Reset call state
      currentCallId = null;
      isCaller = false;
      callDocRef = null;
      
      // Update status and steps
      if (localStream) {
        updateStatus("Ready to start a new call!", "ready");
        step3.classList.remove('active');
        step2.classList.add('active');
      } else {
        updateStatus("Start your camera to begin", "ready");
        step3.classList.remove('active');
        step2.classList.remove('active');
        step1.classList.add('active');
        startBtn.style.display = "flex";
      }
    }

    function updateStatus(message, state) {
      statusBar.textContent = message;
      
      // Update status indicator
      statusIndicator.classList.remove('connected', 'incoming');
      
      // Reset classes
      statusBar.className = "status-bar";
      
      // Apply state-specific styling
      if (state === "connected") {
        statusBar.classList.add("connected");
        statusIndicator.classList.add("connected");
      } else if (state === "incoming") {
        statusBar.classList.add("incoming");
        statusIndicator.classList.add("incoming");
      } else if (state === "calling") {
        statusBar.classList.add("calling");
      } else if (state === "connecting") {
        statusBar.classList.add("calling");
      } else if (state === "disconnected") {
        statusBar.classList.add("error");
      }
    }

    // Check for call ID in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const callIdFromUrl = urlParams.get('call');
    if (callIdFromUrl) {
      callInput.value = callIdFromUrl;
      handleCallInput();
      
      // Auto-start camera if not already started
      if (!localStream) {
        setTimeout(() => {
          if (confirm("You've been invited to a video call. Would you like to start your camera to join?")) {
            startBtn.click();
          }
        }, 500);
      }
    }
  </script>
</body>
</html>
