<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WebRTC Calling App</title>
<style>
body{font-family:Arial;text-align:center;background:#f0f2f5}
video{width:240px;background:black;margin:5px;border-radius:10px}
button{padding:6px 10px;margin:3px}
#users{margin-top:10px}
#incoming{display:none;background:white;padding:10px;border-radius:10px}
</style>
</head>
<body>

<h2>Web Calling System</h2>
<p>Your ID: <span id="myId"></span></p>

<button id="startCam">Start Camera</button>

<div>
<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>
</div>

<h3>Online Users</h3>
<div id="users"></div>

<div id="incoming">
<h3 id="callerName"></h3>
<button id="accept">Accept</button>
<button id="reject">Reject</button>
</div>

<audio id="ringtone" src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg" loop></audio>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, addDoc, deleteDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* ðŸ”¥ Replace this */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser;
let localStream;
let pc;
let currentCallId;

/* Login */
signInAnonymously(auth);

onAuthStateChanged(auth, async user => {
  if(user){
    currentUser = user;
    document.getElementById("myId").innerText = user.uid;

    await setDoc(doc(db,"users",user.uid),{
      online:true
    });

    listenUsers();
    listenIncomingCalls();
  }
});

/* Camera */
document.getElementById("startCam").onclick = async ()=>{
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  document.getElementById("localVideo").srcObject = localStream;
};

/* Users list */
function listenUsers(){
  onSnapshot(collection(db,"users"), snapshot=>{
    const usersDiv = document.getElementById("users");
    usersDiv.innerHTML="";
    snapshot.forEach(docSnap=>{
      if(docSnap.id !== currentUser.uid){
        const btn = document.createElement("button");
        btn.innerText = "Call " + docSnap.id.substring(0,6);
        btn.onclick = ()=> startCall(docSnap.id);
        usersDiv.appendChild(btn);
      }
    });
  });
}

/* Create PeerConnection */
function createPeer(){
  pc = new RTCPeerConnection({
    iceServers:[{urls:"stun:stun.l.google.com:19302"}]
  });

  const remoteStream = new MediaStream();
  document.getElementById("remoteVideo").srcObject = remoteStream;

  pc.ontrack = e=>{
    e.streams[0].getTracks().forEach(track=>{
      remoteStream.addTrack(track);
    });
  };

  localStream.getTracks().forEach(track=>{
    pc.addTrack(track,localStream);
  });

  return pc;
}

/* Start Call */
async function startCall(receiverId){

  createPeer();

  const callDoc = doc(collection(db,"calls"));
  currentCallId = callDoc.id;

  const offerCandidates = collection(callDoc,"offerCandidates");
  const answerCandidates = collection(callDoc,"answerCandidates");

  pc.onicecandidate = e=>{
    if(e.candidate){
      addDoc(offerCandidates,e.candidate.toJSON());
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await setDoc(callDoc,{
    caller: currentUser.uid,
    receiver: receiverId,
    status: "ringing",
    offer: offer
  });

  onSnapshot(callDoc,snap=>{
    const data = snap.data();
    if(data?.answer && !pc.currentRemoteDescription){
      pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
  });

  onSnapshot(answerCandidates,snap=>{
    snap.docChanges().forEach(change=>{
      if(change.type==="added"){
        pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
      }
    });
  });
}

/* Listen Incoming Calls */
function listenIncomingCalls(){
  onSnapshot(collection(db,"calls"), snapshot=>{
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      if(data.receiver === currentUser.uid && data.status==="ringing"){
        currentCallId = docSnap.id;
        document.getElementById("incoming").style.display="block";
        document.getElementById("callerName").innerText="Incoming Call";
        document.getElementById("ringtone").play();
      }
    });
  });
}

/* Accept */
document.getElementById("accept").onclick = async ()=>{

  document.getElementById("ringtone").pause();
  document.getElementById("incoming").style.display="none";

  createPeer();

  const callDoc = doc(db,"calls",currentCallId);
  const offerCandidates = collection(callDoc,"offerCandidates");
  const answerCandidates = collection(callDoc,"answerCandidates");

  pc.onicecandidate = e=>{
    if(e.candidate){
      addDoc(answerCandidates,e.candidate.toJSON());
    }
  };

  const callData = (await getDoc(callDoc)).data();
  await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  await updateDoc(callDoc,{
    answer:answer,
    status:"accepted"
  });

  onSnapshot(offerCandidates,snap=>{
    snap.docChanges().forEach(change=>{
      if(change.type==="added"){
        pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
      }
    });
  });
};

/* Reject */
document.getElementById("reject").onclick = async ()=>{
  document.getElementById("ringtone").pause();
  document.getElementById("incoming").style.display="none";
  await deleteDoc(doc(db,"calls",currentCallId));
};

</script>
</body>
</html>
