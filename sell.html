<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LocalMart â€” Storage Only</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: #f5f5f5; padding: 16px; }
    header { text-align: center; margin-bottom: 16px; }
    h1 { color: #ff6f00; }

    .add-toggle-btn {
      background: #25D366; color: white; border: none; padding: 12px 20px;
      border-radius: 6px; font-weight: bold; cursor: pointer;
      display: block; margin: 0 auto 20px; width: fit-content;
      display: flex; align-items: center; gap: 6px;
    }

    .add-form {
      background: white; padding: 16px; border-radius: 8px; margin-bottom: 24px;
      display: none;
    }
    .add-form.active { display: block; }
    .form-group { margin-bottom: 14px; }
    label { display: block; margin-bottom: 4px; font-weight: bold; }
    input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
    input[type="file"] { padding: 3px; }
    .preview-img {
      width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-top: 8px;
      display: none;
    }

    .listings {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .item-card {
      background: white; border-radius: 8px; overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .item-img {
      width: 100%; height: 140px; background: #f0f0f0;
      display: flex; align-items: center; justify-content: center;
    }
    .item-img img { width: 100%; height: 100%; object-fit: cover; }
    .item-info { padding: 12px; }
    .item-title { font-weight: bold; font-size: 15px; margin-bottom: 4px; }
    .item-price { color: #ff6f00; font-weight: bold; margin: 4px 0; }
    .item-meta { font-size: 0.8em; color: #555; margin-bottom: 8px; }

    .btn-group {
      display: flex; gap: 6px;
    }
    .btn {
      flex: 1; padding: 6px 8px; border: none; border-radius: 4px;
      font-size: 13px; cursor: pointer;
    }
    .btn-whatsapp { background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 4px; }
    .btn-purchase { background: #ff9800; color: white; }

    @media (max-width: 480px) {
      .listings { grid-template-columns: 1fr; }
    }

    .loading { text-align: center; padding: 40px; color: #777; }
  </style>
</head>
<body>

<header>
  <h1>ğŸ›’ LocalMart</h1>
  <p>Firebase Storage Only</p>
</header>

<button class="add-toggle-btn" onclick="toggleAddForm()">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="18" height="18">
    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
  </svg>
  Add Listing
</button>

<div class="add-form" id="addForm">
  <h3>â• Add New Listing</h3>
  <form id="addListingForm">
    <div class="form-group">
      <label>Title *</label>
      <input type="text" id="title" required placeholder="E.g., iPhone 12">
    </div>
    <div class="form-group">
      <label>Price (â‚¹) *</label>
      <input type="number" id="price" required min="1">
    </div>
    <div class="form-group">
      <label>Location *</label>
      <input type="text" id="location" value="Delhi" required>
    </div>
    <div class="form-group">
      <label>Seller Mobile (Optional)</label>
      <input type="tel" id="mobile" placeholder="e.g., 9876543210" maxlength="10">
      <small style="color:#777">If blank, uses admin: 6454678866</small>
    </div>
    <div class="form-group">
      <label>Upload Photo *</label>
      <input type="file" id="imageUpload" accept="image/jpeg,image/png" required>
      <img id="imagePreview" class="preview-img" alt="Preview">
    </div>
    <button type="submit">Post Listing</button>
    <button type="button" onclick="toggleAddForm()" style="background:#999; margin-top:8px; width:100%;">Cancel</button>
  </form>
</div>

<h3>ğŸ›ï¸ Available Items</h3>
<div class="listings" id="listingsContainer">
  <div class="loading">Loading listings...</div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

<script>
  // âœ… Firebase Config (your project)
  const firebaseConfig = {
    apiKey: "AIzaSyCPbOZwAZEMiC1LSDSgnSEPmSxQ7-pR2oQ",
    authDomain: "mirdhuna-25542.firebaseapp.com",
    projectId: "mirdhuna-25542",
    storageBucket: "mirdhuna-25542.firebasestorage.app",
    messagingSenderId: "575924409876",
    appId: "1:575924409876:web:6ba1ed88ce941d9c83b901"
  };

  // Initialize
  firebase.initializeApp(firebaseConfig);
  const storage = firebase.storage();
  const bucket = storage.ref();
  const DEFAULT_ADMIN_PHONE = "6454678866";
  const COD_NOTE = "âœ… Cash on Delivery Available";

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // Global Functions
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  window.toggleAddForm = () => {
    document.getElementById("addForm").classList.toggle("active");
  };

  // Preview image
  document.getElementById("imageUpload").addEventListener("change", function() {
    const file = this.files[0];
    const preview = document.getElementById("imagePreview");
    if (!file) { preview.style.display = "none"; return; }
    if (!/image\/(jpe?g|png)/i.test(file.type)) {
      alert("âŒ Only JPG/PNG.");
      this.value = ""; preview.style.display = "none";
      return;
    }
    preview.src = URL.createObjectURL(file);
    preview.style.display = "block";
  });

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // âœ… Save Listing (Image + JSON)
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  document.getElementById("addListingForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const title = document.getElementById("title").value.trim();
    const price = Number(document.getElementById("price").value);
    const location = document.getElementById("location").value.trim();
    const mobile = document.getElementById("mobile").value.trim();
    const file = document.getElementById("imageUpload").files[0];

    if (mobile && !/^\d{10}$/.test(mobile)) {
      alert("âŒ Mobile must be 10 digits or blank.");
      return;
    }

    try {
      const id = Date.now().toString();
      const imgPath = `images/${id}_${file.name}`;
      const jsonPath = `listings/${id}.json`;

      // Upload image
      await bucket.child(imgPath).put(file);
      const imgUrl = await bucket.child(imgPath).getDownloadURL();

      // Save metadata as JSON
      const metadata = {
        id,
        title,
        price,
        location,
        mobile: mobile || "",
        imageUrl: imgUrl,
        status: "active",
        createdAt: Date.now()
      };

      const jsonBlob = new Blob([JSON.stringify(metadata, null, 2)], { type: 'application/json' });
      await bucket.child(jsonPath).put(jsonBlob);

      alert("âœ… Listing saved to Firebase Storage!");
      document.getElementById("addListingForm").reset();
      document.getElementById("imagePreview").style.display = "none";
      toggleAddForm();
      loadListings();
    } catch (err) {
      console.error(err);
      alert("âŒ " + (err.message || "Upload failed"));
    }
  });

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // âœ… Load Listings (from /listings/*.json)
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  async function loadListings() {
    const container = document.getElementById("listingsContainer");
    try {
      const listRef = bucket.child("listings/");
      const res = await listRef.listAll();
      const jsonFiles = res.items.filter(item => item.name.endsWith('.json'));

      if (jsonFiles.length === 0) {
        container.innerHTML = "<p>No listings yet.</p>";
        return;
      }

      container.innerHTML = "";
      const listings = [];

      for (const fileRef of jsonFiles) {
        try {
          const url = await fileRef.getDownloadURL();
          const response = await fetch(url);
          const data = await response.json();
          listings.push(data);
        } catch (e) {
          console.warn("Skip invalid listing:", fileRef.name);
        }
      }

      // Sort newest first
      listings.sort((a, b) => b.createdAt - a.createdAt);

      listings.forEach(item => {
        const sellerPhone = (item.mobile && /^\d{10}$/.test(item.mobile)) ? item.mobile : DEFAULT_ADMIN_PHONE;
        const waText = encodeURIComponent(
          `Hi, I'm interested in:\nğŸ“Œ *${item.title}*\nğŸ’° â‚¹${item.price.toLocaleString()}\nğŸ“ ${item.location}\n${COD_NOTE}\n\nMore details? Thanks!`
        );
        const waURL = `https://wa.me/91${sellerPhone}?text=${waText}`;

        const statusText = item.status === "purchased" ? "â³ Purchased" : "ğŸŸ¢ Active";

        const card = document.createElement("div");
        card.className = "item-card";
        card.innerHTML = `
          <div class="item-img">
            <img src="${item.imageUrl || 'https://via.placeholder.com/140?text=ğŸ“·'}" 
                 onerror="this.src='https://via.placeholder.com/140?text=ğŸ“·'">
          </div>
          <div class="item-info">
            <div class="item-title">${item.title}</div>
            <div class="item-price">â‚¹${item.price.toLocaleString()}</div>
            <div class="item-meta">
              ğŸ“ ${item.location}
              ${item.mobile ? ` | ğŸ“± ${item.mobile}` : ""}
              <br><small>${statusText}</small>
            </div>
            <div class="btn-group">
              <a href="${waURL}" target="_blank" class="btn btn-whatsapp">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="white">
                  <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.883 11.883 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
                WhatsApp
              </a>
              ${item.status === "active" ? 
                `<button class="btn btn-purchase" onclick="markAsPurchased('${item.id}')">ğŸ›’ Purchased</button>` 
                : ""}
            </div>
          </div>`;
        container.appendChild(card);
      });
    } catch (err) {
      container.innerHTML = `<p class="loading">âŒ Load failed: ${err.message}</p>`;
    }
  }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // âœ… Mark as Purchased (overwrite JSON)
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  window.markAsPurchased = async function(listingId) {
    if (!confirm("Confirm purchase?")) return;

    try {
      const jsonPath = `listings/${listingId}.json`;
      const fileRef = bucket.child(jsonPath);

      // Fetch current
      const url = await fileRef.getDownloadURL();
      const res = await fetch(url);
      const data = await res.json();

      // Update
      data.status = "purchased";
      data.purchasedAt = Date.now();

      // Save back
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      await fileRef.put(blob);

      alert("âœ… Marked as purchased!");
      loadListings();
    } catch (err) {
      alert("âŒ " + err.message);
    }
  };

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // Init
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  window.addEventListener("load", loadListings);
</script>

</body>
</html>
