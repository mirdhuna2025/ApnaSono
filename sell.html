<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Listings (Vanilla JS + Firebase)</title>

<!-- Firebase Compat (global firebase object) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

<style>
/* Header */
header {
  backdrop-filter: blur(12px);
  background: #d4edda;   
  position: sticky;
  top: 0;
  z-index: 1000;
  padding: 1px 0;
}
.header-container {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  width: 90%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 18px;
}
.sono-olx {
  background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
  background-size: 400% 400%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: rainbow 4s ease infinite;
  font-size: 2.3rem;
  letter-spacing: -1px;
  margin: 0;
  font-family: 'Playfair Display', serif;
}
@keyframes rainbow {
  0% { background-position: 0% 50% }
  50% { background-position: 100% 50% }
  100% { background-position: 0% 50% }
}

/* Ad Container (top) */
#ad-container {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 8px 0;
  background: #fff;
  border-bottom: 1px solid #eee;
  width: 100%;
}

/* Root & Cards */
:root{
  --primary:#25D366;
  --danger:#ef4444;
  --bg:#f4f6f8;
  --card:#ffffff;
  --radius:14px;
  --shadow:0 10px 25px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg)}
#listingsContainer{
  display:grid;
  gap:12px;
  padding:12px;
  grid-template-columns: repeat(2, 1fr);
}
@media(min-width:768px){
  #listingsContainer{ grid-template-columns: repeat(3, 1fr); }
}
@media(min-width:1024px){
  #listingsContainer{ grid-template-columns: repeat(4, 1fr); }
}

/* Card */
.item-card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.item-info {
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.item-title { font-weight: 600; }
.item-price { color: var(--danger); font-weight: 700; float: right; }
.item-location { color: #555; font-size: 14px; }

.btn-call, .btn-whatsapp {
  display: inline-block;
  text-decoration: none;
  padding: 6px 10px;
  border-radius: 8px;
  font-weight: 500;
  margin-right: 6px;
}
.btn-call { background: var(--primary); color: #fff; }
.btn-whatsapp { background: #25D366; color: #fff; }

/* Slider */
.slider{position:relative; cursor:pointer;}
.slider img{
  width:100%;
  height:120px;
  object-fit:cover;
  display: block;
}
.dots{
  position:absolute;
  bottom:8px;
  width:100%;
  display:flex;
  justify-content:center;
  gap:6px;
}
.dot{
  width:8px;height:8px;border-radius:50%;
  background:#ddd;
}
.dot.active{background:#25D366}

/* ðŸ”¹ AD CARD (full row) */
.ad-card {
  grid-column: 1 / -1; /* Span all columns */
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 10px;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 70px;
}

/* FAB */
.fab {
  position: fixed;
  bottom: 22px;
  right: 22px;
  width: 75px;
  height: 75px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #ff6a00, #ff3d00);
  color: white;
  border: none;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  cursor: pointer;
  z-index: 9999;
  font-size: 24px;
}
.fab::after {
  content: '';
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: inherit;
  background: inherit;
  filter: blur(12px);
  opacity: 0.5;
  z-index: -1;
}

/* Modal */
#modalBackdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
#modalContent{
  background:#fff;
  width:92%;
  max-width:420px;
  padding:18px;
  border-radius:14px;
  position:relative;
}
#modalContent input{
  width:100%;
  padding:12px;
  margin-bottom:10px;
  border:1px solid #ddd;
  border-radius:8px;
}
.close-btn{
  position:absolute;
  top:10px;
  right:12px;
  background:none;
  border:none;
  font-size:18px;
  cursor:pointer;
  font-weight:bold;
  color:#555;
}
.close-btn:hover{ color:#ef4444; }

/* Image Preview */
#previewBackdrop{
  position: fixed;
  inset:0;
  background: rgba(0,0,0,0.85);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10000;
}
#previewBackdrop img{
  max-width:95%;
  max-height:95%;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,0.5);
  object-fit:contain;
}
</style>
</head>
<body>

<!-- ðŸ”¹ TOP AD -->
<div id="ad-container">
  <script>
    atOptions = {
      'key' : 'cbe6058f5f45274622f5fdeb5dd20c29',
      'format' : 'iframe',
      'height' : 60,
      'width' : 468,
      'params' : {}
    };
  </script>
  <script src="https://www.highperformanceformat.com/cbe6058f5f45274622f5fdeb5dd20c29/invoke.js"></script>
</div>

<!-- Firebase Init (fixed - no duplicates) -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCPbOZwAZEMiC1LSDSgnSEPmSxQ7-pR2oQ",
    authDomain: "mirdhuna-25542.firebaseapp.com",
    projectId: "mirdhuna-25542",
    storageBucket: "mirdhuna-25542.firebasestorage.app",
    appId: "1:575924409876:web:6ba1ed88ce941d9c83b901"
  };
  firebase.initializeApp(firebaseConfig);
  window.storage = firebase.storage();
</script>

<header>
  <div class="header-container">
    <h1 class="sono-olx">SONO OLX</h1>
  </div>
</header>

<div id="listingsContainer"></div>

<!-- FAB Button -->
<button class="fab" id="fabBtn">+ Sell</button>

<!-- Add Listing Modal -->
<div id="modalBackdrop" style="display:none;">
  <div id="modalContent">
    <button class="close-btn" id="closeModal">âœ–</button>
    <h3>Add Listing</h3>
    <form id="listingForm">
      <input type="text" id="inpTitle" placeholder="Title" required />
      <input type="number" id="inpPrice" placeholder="Price" required />
      <input type="text" id="inpLocation" placeholder="Location" required />
      <input type="tel" id="inpMobile" placeholder="Mobile" required />
      <input type="file" id="inpImages" multiple accept="image/*" required />
      <button type="submit" class="btn btn-success">Send to Admin</button>
    </form>
  </div>
</div>

<!-- Image Preview Modal -->
<div id="previewBackdrop" style="display:none;">
  <img id="previewImg" src="" alt="Preview" />
</div>

<script>
// ============ STATE ============
let listings = [];
let previewImages = [];
let previewIndex = 0;
let resizeTimeout;

// ============ DOM ELEMENTS ============
const container = document.getElementById('listingsContainer');
const fabBtn = document.getElementById('fabBtn');
const modalBackdrop = document.getElementById('modalBackdrop');
const closeModal = document.getElementById('closeModal');
const listingForm = document.getElementById('listingForm');
const previewBackdrop = document.getElementById('previewBackdrop');
const previewImg = document.getElementById('previewImg');

// ============ HELPER: Get current grid column count ============
function getGridColumnCount() {
  const style = getComputedStyle(container);
  // Count the number of column tracks (e.g., "1fr 1fr" â†’ 2)
  return style.gridTemplateColumns.split(' ').filter(c => c.trim()).length;
}

// ============ HELPER: Create ad card element ============
function createAdCard() {
  const adCard = document.createElement('div');
  adCard.className = 'ad-card';
  adCard.innerHTML = `
    <div style="width:100%;max-width:728px;text-align:center;">
      <script>
        atOptions = {
          'key' : 'cbe6058f5f45274622f5fdeb5dd20c29',
          'format' : 'iframe',
          'height' : 90,
          'width' : 728,
          'params' : {}
        };
      </script>
      <script src="https://www.highperformanceformat.com/cbe6058f5f45274622f5fdeb5dd20c29/invoke.js"></script>
      <noscript><a href="https://www.highperformanceformat.com/cbe6058f5f45274622f5fdeb5dd20c29/invoke" target="_blank"><img src="https://www.highperformanceformat.com/cbe6058f5f45274622f5fdeb5dd20c29/invoke" alt="ad" border="0"></a></noscript>
    </div>
  `;
  return adCard;
}

// ============ LOAD LISTINGS ============
async function loadListings() {
  try {
    const storageRef = window.storage.ref('listings');
    const res = await storageRef.listAll();
    
    const items = await Promise.all(
      res.prefixes.map(async (folderRef) => {
        try {
          const jsonRef = folderRef.child('data.json');
          const url = await jsonRef.getDownloadURL();
          const response = await fetch(url);
          return await response.json();
        } catch (e) {
          return null;
        }
      })
    );
    
    listings = items
      .filter(Boolean)
      .sort((a, b) => b.createdAt - a.createdAt);
    
    renderListings();
  } catch (err) {
    console.log("No listings found or error loading:", err);
  }
}

// ============ RENDER LISTINGS (with ads on even rows) ============
function renderListings() {
  container.innerHTML = '';
  const cols = getGridColumnCount();
  let itemCounter = 0;
  let rowNumber = 1;
  
  listings.forEach((item, idx) => {
    // Check if we're starting a new row
    if (itemCounter > 0 && itemCounter % cols === 0) {
      rowNumber++;
      // Insert ad on even rows (2, 4, 6...)
      if (rowNumber % 2 === 0) {
        container.appendChild(createAdCard());
      }
    }
    
    // Create and append item card
    container.appendChild(createItemCard(item, idx));
    itemCounter++;
  });
  
  // Handle trailing ad if last row was even and empty (optional)
  // Not needed for most cases
}

// ============ CREATE ITEM CARD ============
function createItemCard(item, idx) {
  const card = document.createElement('div');
  card.className = 'item-card';
  
  // Slider
  const slider = document.createElement('div');
  slider.className = 'slider';
  
  if (item.images && item.images.length > 0) {
    const img = document.createElement('img');
    img.src = item.images[0];
    img.dataset.index = '0';
    img.dataset.listing = idx;
    img.onclick = () => openPreview(item.images, 0);
    
    // Auto-rotate slider (only if multiple images)
    if (item.images.length > 1) {
      let current = 0;
      const interval = setInterval(() => {
        if (document.contains(img)) {
          current = (current + 1) % item.images.length;
          img.src = item.images[current];
          img.dataset.index = current;
          // Update dots
          const dots = slider.querySelectorAll('.dot');
          dots.forEach((d, i) => d.classList.toggle('active', i === current));
        } else {
          clearInterval(interval);
        }
      }, 3000);
    }
    
    slider.appendChild(img);
    
    // Dots navigation
    const dots = document.createElement('div');
    dots.className = 'dots';
    item.images.forEach((_, i) => {
      const dot = document.createElement('span');
      dot.className = 'dot' + (i === 0 ? ' active' : '');
      dot.onclick = (e) => {
        e.stopPropagation();
        img.src = item.images[i];
        img.dataset.index = i;
        dots.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
        dot.classList.add('active');
      };
      dots.appendChild(dot);
    });
    slider.appendChild(dots);
  }
  
  // Info section
  const info = document.createElement('div');
  info.className = 'item-info';
  
  const title = document.createElement('div');
  title.className = 'item-title';
  title.textContent = item.title;
  
  const price = document.createElement('div');
  price.className = 'item-price';
  price.textContent = 'â‚¹' + item.price;
  
  const location = document.createElement('div');
  location.className = 'item-location';
  location.textContent = 'ðŸ“ ' + item.location;
  
  const callBtn = document.createElement('a');
  callBtn.href = `tel:${item.mobile}`;
  callBtn.className = 'btn btn-call';
  callBtn.textContent = 'ðŸ“ž';
  
  // âœ… Fixed: Removed extra spaces in WhatsApp URL
  const waBtn = document.createElement('a');
  waBtn.href = `https://wa.me/91${item.mobile.replace(/\D/g,'')}`;
  waBtn.className = 'btn btn-whatsapp';
  waBtn.textContent = 'ðŸ’¬ WhatsApp';
  waBtn.target = '_blank';
  waBtn.rel = 'noopener noreferrer';
  
  info.appendChild(title);
  info.appendChild(price);
  info.appendChild(location);
  info.appendChild(callBtn);
  info.appendChild(waBtn);
  
  card.appendChild(slider);
  card.appendChild(info);
  return card;
}

// ============ MODAL FUNCTIONS ============
fabBtn.onclick = () => { modalBackdrop.style.display = 'flex'; };
closeModal.onclick = () => { modalBackdrop.style.display = 'none'; };
modalBackdrop.onclick = (e) => { if (e.target === modalBackdrop) modalBackdrop.style.display = 'none'; };

// ============ FORM SUBMIT ============
listingForm.onsubmit = async (e) => {
  e.preventDefault();
  
  const title = document.getElementById('inpTitle').value;
  const price = document.getElementById('inpPrice').value;
  const location = document.getElementById('inpLocation').value;
  const mobile = document.getElementById('inpMobile').value.replace(/\D/g,'');
  const files = document.getElementById('inpImages').files;
  
  const id = Date.now().toString();
  const basePath = 'pendingListings/' + id;
  const imageUrls = [];
  
  // Upload images
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const imgRef = window.storage.ref(`${basePath}/images/${file.name}`);
    await imgRef.put(file);
    const url = await imgRef.getDownloadURL();
    imageUrls.push(url);
  }
  
  // Upload data.json
  const data = {
    title, price, location, mobile,
    images: imageUrls,
    status: 'pending',
    createdAt: Date.now()
  };
  const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
  const jsonRef = window.storage.ref(`${basePath}/data.json`);
  await jsonRef.put(blob);
  
  alert('âœ… Listing sent for admin approval');
  modalBackdrop.style.display = 'none';
  listingForm.reset();
};

// ============ IMAGE PREVIEW ============
function openPreview(images, index) {
  previewImages = images;
  previewIndex = index;
  previewImg.src = images[index];
  previewBackdrop.style.display = 'flex';
}

previewBackdrop.onclick = (e) => {
  if (e.target === previewBackdrop) {
    previewBackdrop.style.display = 'none';
  }
};

// Keyboard navigation for preview
document.addEventListener('keydown', (e) => {
  if (previewBackdrop.style.display === 'flex') {
    if (e.key === 'ArrowLeft') {
      previewIndex = (previewIndex - 1 + previewImages.length) % previewImages.length;
      previewImg.src = previewImages[previewIndex];
    } else if (e.key === 'ArrowRight') {
      previewIndex = (previewIndex + 1) % previewImages.length;
      previewImg.src = previewImages[previewIndex];
    } else if (e.key === 'Escape') {
      previewBackdrop.style.display = 'none';
    }
  }
});

// ============ RESIZE HANDLER (re-render ads on breakpoint change) ============
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    // Only re-render if column count actually changed
    const newCols = getGridColumnCount();
    if (newCols !== window.lastColCount) {
      window.lastColCount = newCols;
      renderListings();
    }
  }, 150);
});
// Initialize lastColCount
window.lastColCount = getGridColumnCount();

// ============ INIT ============
window.addEventListener('DOMContentLoaded', loadListings);
</script>

</body>
</html>
