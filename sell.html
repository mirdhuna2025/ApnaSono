<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Listings</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; }
  .btn { padding: 8px 16px; border: none; cursor: pointer; border-radius: 4px; }
  .btn-success { background: #25D366; color: white; }
  .btn-secondary { background: #ccc; }
  .item-card { display:flex; margin: 10px; border:1px solid #ddd; border-radius:8px; overflow:hidden; }
  .item-img img { width:120px; height:120px; object-fit:cover; cursor:pointer; }
  .item-info { padding:10px; flex:1; }
  .item-title { font-weight:bold; margin-bottom:5px; }
  .item-price { color:#ef4444; margin-bottom:5px; }
  .meta-badge { background:#eee; padding:2px 6px; border-radius:4px; margin-right:5px; font-size:12px; }
  .btn-group { margin-top:10px; display:flex; gap:5px; }
  /* Modal styles */
  #modalBackdrop { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:999; }
  #modalBackdrop.active { display:flex; }
  #modalContent { background:white; padding:20px; border-radius:8px; width:90%; max-width:400px; }
</style>
</head>
<body>

<!-- FAB to open Add Listing -->
<button onclick="openAddForm()" class="btn btn-success" style="position:fixed; bottom:20px; right:20px;">+ Add Listing</button>

<!-- Listings Container -->
<div id="listingsContainer" style="padding:10px;"></div>

<!-- Add Listing Modal -->
<div id="modalBackdrop">
  <div id="modalContent">
    <h3>Add Listing</h3>
    <form id="addListingForm" onsubmit="event.preventDefault(); sendToAdmin();">
      <input type="text" id="title" placeholder="Item title *" required style="width:100%; margin-bottom:10px;">
      <input type="number" id="price" placeholder="Price *" required style="width:100%; margin-bottom:10px;">
      <input type="text" id="location" placeholder="Location *" required style="width:100%; margin-bottom:10px;">
      <input type="text" id="mobile" placeholder="Your mobile (optional)" style="width:100%; margin-bottom:10px;">
      <input type="file" id="imageUpload" accept="image/*" style="margin-bottom:10px;">
      <div id="previewContainer" style="display:none; margin-bottom:10px;">
        <img id="imagePreview" src="" alt="Preview" style="max-width:100px;">
      </div>
      <button type="submit" class="btn btn-success">Send to Admin (WhatsApp)</button>
      <button type="button" class="btn btn-secondary" onclick="closeAddForm()">Cancel</button>
    </form>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
// ==============================
// Admin WhatsApp Number
// ==============================
const ADMIN_MOBILE = "6303438082";

// ==============================
// Modal Controls
// ==============================
window.openAddForm = () => {
  const modal = document.getElementById('modalBackdrop');
  if (!modal) return;
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
};

window.closeAddForm = () => {
  const modal = document.getElementById('modalBackdrop');
  if (!modal) return;
  modal.classList.remove('active');
  document.body.style.overflow = '';
  document.getElementById("addListingForm")?.reset();
  const container = document.getElementById('previewContainer');
  if (container) container.style.display = 'none';
};

// ==============================
// Image Preview
// ==============================
document.addEventListener('DOMContentLoaded', () => {
  const imageUpload = document.getElementById('imageUpload');
  if (!imageUpload) return;

  imageUpload.addEventListener('change', () => {
    const file = imageUpload.files?.[0];
    const preview = document.getElementById('imagePreview');
    const container = document.getElementById('previewContainer');

    if (file) {
      const url = URL.createObjectURL(file);
      preview.src = url;
      container.style.display = 'block';
    } else {
      container.style.display = 'none';
    }
  });
});

// ==============================
// Send Form to Admin via WhatsApp
// ==============================
window.sendToAdmin = () => {
  const title = document.getElementById("title")?.value.trim();
  const price = document.getElementById("price")?.value.trim();
  const location = document.getElementById("location")?.value.trim();
  const sellerMobile = document.getElementById("mobile")?.value.trim();
  const file = document.getElementById("imageUpload")?.files[0];

  if (!title || !price || !location) {
    return alert("‚ö†Ô∏è Please fill all required fields!");
  }

  let waMessage = `
Hello Admin,

A user wants to post a listing:

üìç Location: ${location}
üì± Mobile: ${sellerMobile || 'Not provided'}
üõí Item: ${title}
üí∞ Price: ‚Çπ${Number(price).toLocaleString()}
`;

  if (file) waMessage += "\nüì∑ Image attached (send manually)";

  const waURL = `https://wa.me/91${ADMIN_MOBILE}?text=${encodeURIComponent(waMessage)}`;
  window.open(waURL, "_blank");

  closeAddForm();
};

// ==============================
// Firebase Config (for read-only listings display)
// ==============================
const firebaseConfig = {
  apiKey: "AIzaSyCPbOZwAZEMiC1LSDSgnSEPmSxQ7-pR2oQ",
  authDomain: "mirdhuna-25542.firebaseapp.com",
  projectId: "mirdhuna-25542",
  storageBucket: "mirdhuna-25542.firebasestorage.app",
  messagingSenderId: "575924409876",
  appId: "1:575924409876:web:6ba1ed88ce941d9c83b901"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const bucket = storage.ref();

// ==============================
// Load Listings for Users (read-only)
// ==============================
async function loadListings() {
  const container = document.getElementById("listingsContainer");
  if (!container) return;

  container.innerHTML = `<div class="empty-state"><p>Loading listings‚Ä¶</p></div>`;

  try {
    const listRef = bucket.child("listings/");
    const res = await listRef.listAll();
    const jsonFiles = res.items.filter(item => item.name.endsWith(".json"));

    const items = [];
    for (const fileRef of jsonFiles) {
      const url = await fileRef.getDownloadURL();
      const resp = await fetch(url);
      if (resp.ok) items.push(await resp.json());
    }

    items.sort((a, b) => b.createdAt - a.createdAt);

    if (items.length === 0) {
      container.innerHTML = `<div class="empty-state"><p>No listings yet.</p></div>`;
      return;
    }

    container.innerHTML = "";
    items.forEach(item => {
      const waMessage = `
Hi, I'm interested in:

üìç Location: ${item.location}
üì± Mobile: ${item.mobile}
üõí Item: ${item.title}
üí∞ Price: ‚Çπ${item.price.toLocaleString()}
üì∑ Image: ${item.imageUrl}
üÜî Order ID: ${item.orderId}
üí≥ Payment: ${item.paymentMode}

Thanks!
`.trim();

      const waURL = `https://wa.me/91${item.mobile}?text=${encodeURIComponent(waMessage)}`;

      const card = document.createElement("div");
      card.className = "item-card";

      card.innerHTML = `
        <div class="item-img">
          <img loading="lazy" src="${item.imageUrl}" alt="${item.title}" onclick="openImage('${item.imageUrl}')">
        </div>
        <div class="item-info">
          <div class="item-title">${item.title}</div>
          <div class="item-price">‚Çπ${item.price.toLocaleString()}</div>
          <div class="item-meta">
            <span class="meta-badge">üìç ${item.location}</span>
            ${item.status === "purchased" ? `<span class="meta-badge" style="background:#fee2e2;color:#ef4444">Purchased</span>` : ""}
          </div>
          <div class="btn-group">
            <a href="${waURL}" class="btn btn-success" target="_blank">WhatsApp</a>
          </div>
        </div>
      `;
      container.appendChild(card);
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = `<div class="empty-state"><p>‚ùå Error loading listings.<br>${err.message}</p></div>`;
  }
}

// ==============================
// Open Full Image
// ==============================
window.openImage = (url) => {
  const newWin = window.open("", "_blank", "width=800,height=600,scrollbars=yes");
  if (newWin) {
    newWin.document.write(`
      <html>
        <head><title>Image</title></head>
        <body style="margin:0;background:#000">
          <img src="${url}" style="max-width:100%;max-height:100vh;display:block;margin:auto">
        </body>
      </html>
    `);
    newWin.document.close();
  } else {
    alert("Popup blocked. Please allow popups to view image.");
  }
};

// ==============================
// Auto Load Listings on Start
// ==============================
document.addEventListener("DOMContentLoaded", () => {
  loadListings();
});
</script>
</body>
</html>
