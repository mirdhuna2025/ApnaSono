<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    .container { max-width: 900px; margin: 0 auto; }
    h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    .item-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .item-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
    .item-price { color: #28a745; font-weight: bold; margin-bottom: 10px; }
    .item-images { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    .item-images img {
      width: 70px; height: 70px; object-fit: cover;
      border-radius: 4px; border: 1px solid #eee;
    }
    .actions { display: flex; gap: 10px; }
    button {
      padding: 8px 16px; border: none; border-radius: 4px;
      cursor: pointer; font-weight: 500; transition: background 0.2s;
    }
    .approve-btn { background: #28a745; color: white; }
    .approve-btn:hover { background: #218838; }
    .remove-btn { background: #dc3545; color: white; }
    .remove-btn:hover { background: #c82333; }
    .loading { color: #666; font-style: italic; }
    .empty { color: #888; text-align: center; padding: 30px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚è≥ Pending Listings</h2>
    <div id="listings-container">
      <p class="loading">Loading listings...</p>
    </div>
  </div>

  <!-- Firebase SDK (ES Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getStorage, ref, listAll, getDownloadURL, uploadBytes, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCPbOZwAZEMiC1LSDSgnSEPmSxQ7-pR2oQ",
      authDomain: "mirdhuna-25542.firebaseapp.com",
      projectId: "mirdhuna-25542",
      storageBucket: "mirdhuna-25542.firebasestorage.app"
    };
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    // DOM Elements
    const container = document.getElementById('listings-container');

    // Load and render pending listings
    async function loadPendingListings() {
      try {
        const storageRef = ref(storage, "pendingListings");
        const result = await listAll(storageRef);
        
        if (result.prefixes.length === 0) {
          container.innerHTML = '<p class="empty">No pending listings found ‚úÖ</p>';
          return;
        }

        const items = await Promise.all(
          result.prefixes.map(async (folderRef) => {
            try {
              const dataUrl = await getDownloadURL(ref(storage, `${folderRef.fullPath}/data.json`));
              const response = await fetch(dataUrl);
              const data = await response.json();
              return { id: folderRef.name, ...data, folderPath: folderRef.fullPath };
            } catch (err) {
              console.error(`Error loading ${folderRef.name}:`, err);
              return null;
            }
          })
        );
        
        // Filter out failed loads
        const validItems = items.filter(item => item !== null);
        renderListings(validItems);
        
      } catch (error) {
        console.error("Error loading listings:", error);
        container.innerHTML = `<p style="color:#dc3545">‚ùå Error loading listings: ${error.message}</p>`;
      }
    }

    // Render listings to DOM
    function renderListings(items) {
      if (items.length === 0) {
        container.innerHTML = '<p class="empty">No pending listings found ‚úÖ</p>';
        return;
      }

      container.innerHTML = items.map(item => {
        const imagesHtml = (item.images || []).map(imgUrl => 
          `<img src="${imgUrl}" alt="${item.title || 'Listing'}" onerror="this.style.display='none'"/>`
        ).join('');
        
        return `
          <div class="item-card" data-id="${item.id}" data-path="${item.folderPath}">
            <div class="item-title">${escapeHtml(item.title || 'Untitled')}</div>
            <div class="item-price">‚Çπ${item.price || '0'}</div>
            <div class="item-images">${imagesHtml || '<small>No images</small>'}</div>
            <div class="actions">
              <button class="approve-btn" data-action="approve">‚úÖ Approve</button>
              <button class="remove-btn" data-action="remove">üóëÔ∏è Remove</button>
            </div>
          </div>
        `;
      }).join('');

      // Attach event listeners
      container.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', handleAction);
      });
    }

    // Handle Approve / Remove actions
    async function handleAction(e) {
      const button = e.currentTarget;
      const card = button.closest('.item-card');
      const id = card.dataset.id;
      const folderPath = card.dataset.path;
      const action = button.dataset.action;

      button.disabled = true;
      const originalText = button.textContent;
      button.textContent = action === 'approve' ? 'Processing...' : 'Deleting...';

      try {
        if (action === 'approve') {
          await approveListing(id, folderPath);
          button.textContent = '‚úÖ Approved';
          setTimeout(() => card.remove(), 800);
        } else if (action === 'remove') {
          await removeListing(folderPath);
          button.textContent = 'üóëÔ∏è Removed';
          setTimeout(() => card.remove(), 800);
        }
      } catch (err) {
        console.error(`${action} error:`, err);
        alert(`‚ùå ${action === 'approve' ? 'Approval' : 'Removal'} failed: ${err.message}`);
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    // Approve: Move item from pendingListings to listings
    async function approveListing(id, sourcePath) {
      // Read data from pending
      const sourceDataRef = ref(storage, `${sourcePath}/data.json`);
      const dataUrl = await getDownloadURL(sourceDataRef);
      const response = await fetch(dataUrl);
      const data = await response.json();

      // Upload to approved listings
      const destRef = ref(storage, `listings/${id}/data.json`);
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      await uploadBytes(destRef, blob);

      // Optionally: delete from pending after successful copy
      await deleteObject(sourceDataRef);
      // Delete folder metadata if needed (Firebase Storage doesn't have real folders)
      
      alert(`‚úÖ "${data.title}" approved & published!`);
    }

    // Remove: Delete item from pendingListings
    async function removeListing(folderPath) {
      if (!confirm('‚ö†Ô∏è Are you sure you want to REMOVE this pending listing? This cannot be undone.')) {
        return;
      }
      
      // Delete the data.json file (primary reference)
      const dataRef = ref(storage, `${folderPath}/data.json`);
      await deleteObject(dataRef);
      
      // Note: Firebase Storage doesn't support deleting "folders" directly.
      // If you have image files in the same folder, you'd need to list and delete them too.
      // For now, we delete the metadata which effectively removes the listing.
      
      alert('üóëÔ∏è Listing removed from pending');
    }

    // Utility: Escape HTML to prevent XSS
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', loadPendingListings);
  </script>
</body>
</html>
